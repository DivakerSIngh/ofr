@model OneFineRateBLL.Entities.BookingGuestDetails
@using OneFineRateAppUtil

@{
    ViewBag.Title = "Update GuestInformation";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .ptype {
        width: 100% !important;
    }

    #frmBookingAmend .select2 {
        width: 50% !important;
        float: left !important;
    }

    .select2-container--default .select2-selection--single {
        height: 34px;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered{
        line-height:33px;
    }
</style>


@using (Html.BeginForm("UpdateGuestInformation", "BookingTG", FormMethod.Post, new { id = "frmBookingAmend", role = "form" }))
{
    String GrandTotal = "";
    int CountIndex = 0;

    @Html.HiddenFor(m => Model.sPropertyName)
    @Html.HiddenFor(m => Model.sPropertyAddress)
    @Html.HiddenFor(m => Model.iStarCategory)

    @Html.HiddenFor(m => Model.objBooking.iBookingId)
    @Html.HiddenFor(m => Model.objBooking.iPropId)
    @Html.HiddenFor(m => Model.objBooking.iCustomerId)
    @Html.HiddenFor(m => Model.objBooking.iGuestId)
    @Html.HiddenFor(m => Model.objBooking.iCountryOffset)
    @Html.HiddenFor(m => Model.objBooking.sCountryTimeZone)
    @Html.HiddenFor(m => Model.objBooking.dtCheckIn)
    @Html.HiddenFor(m => Model.objBooking.dtChekOut)
    @Html.HiddenFor(m => Model.objBooking.dtReservationDate)
    @Html.HiddenFor(m => Model.objBooking.cBookingType)
    @Html.HiddenFor(m => Model.objBooking.iNegotiateAttempts)
    @Html.HiddenFor(m => Model.objBooking.sPromoCode)
    @Html.HiddenFor(m => Model.objBooking.bPromoDiscount)
    @Html.HiddenFor(m => Model.objBooking.bPromoAmenity)
    @Html.HiddenFor(m => Model.objBooking.sTitleOFR)
    @Html.HiddenFor(m => Model.objBooking.sFirstNameOFR)
    @Html.HiddenFor(m => Model.objBooking.sLastNameOFR)
    @Html.HiddenFor(m => Model.objBooking.sEmailOFR)
    @Html.HiddenFor(m => Model.objBooking.sMobileOFR)
    @Html.HiddenFor(m => Model.objBooking.dtActionDate)
    @Html.HiddenFor(m => Model.objBooking.iActionBy)
    @Html.HiddenFor(m => Model.objBooking.BookingStatus)
    @Html.HiddenFor(m => Model.objBooking.PaymentStatus)
    @Html.HiddenFor(m => Model.objBooking.ActualBookingType)
    @Html.HiddenFor(m => Model.objBooking.dTotalNegotiateAmount)
    @Html.HiddenFor(m => Model.objBooking.dAdvNegotiateAmount)
    @Html.HiddenFor(m => Model.objBooking.dBidAmount)
    @Html.HiddenFor(m => Model.objBooking.dTotalAmount)
    @Html.HiddenFor(m => Model.objBooking.dTotalComm)
    @Html.HiddenFor(m => Model.objBooking.dTaxes)
    @Html.HiddenFor(m => Model.objBooking.dTaxesForHotel)
    @Html.HiddenFor(m => Model.objBooking.dTotalExtraBedAmount)
    @Html.HiddenFor(m => Model.objBooking.dDiscountedBidPrice)
    @Html.HiddenFor(m => Model.objBooking.dCustomerPayable)
    @Html.HiddenFor(m => Model.objBooking.bIsFeedBackEmailSent)
    @Html.HiddenFor(m => Model.objBooking.bIsCustSmsSent)
    @Html.HiddenFor(m => Model.objBooking.bIsHotelSmsSent)
    @Html.HiddenFor(m => Model.objBooking.iCounterOffer)
    @Html.HiddenFor(m => Model.objBooking.iLinkedBookingId)
    @Html.HiddenFor(m => Model.objBooking.bInvBlocked)
    @Html.HiddenFor(m => Model.objBooking.sExtra1)
    @Html.HiddenFor(m => Model.objBooking.dccPrice)
    @Html.HiddenFor(m => Model.objBooking.dccDiscount)
    @Html.HiddenFor(m => Model.objBooking.dSafeguardComm)
    @Html.HiddenFor(m => Model.objBooking.ccType)
    @Html.HiddenFor(m => Model.objBooking.dTotalCommOriginal)
    @Html.HiddenFor(m => Model.objBooking.dTaxesOriginal)
    @Html.HiddenFor(m => Model.objBooking.sProvisionalBookingIdTG)
    @Html.HiddenFor(m => Model.objBooking.sProvisionalTrxnTypeTG)
    @Html.HiddenFor(m => Model.objBooking.sFinalTrxnTypeTG)
    @Html.HiddenFor(m => Model.objBooking.sFinalBookingIdTG)
    @Html.HiddenFor(m => Model.objBooking.bSyncToChannelMgr)
    @Html.HiddenFor(m => Model.objBooking.dtSyncToChannelMgr)
    @Html.HiddenFor(m => Model.objBooking.cSyncStatus)
    @Html.HiddenFor(m => Model.objBooking.iBidStarCategory)
    @Html.HiddenFor(m => Model.objBooking.sBidType)
    @Html.HiddenFor(m => Model.objBooking.sIDs)
    @Html.HiddenFor(m => Model.objBooking.dRefundAmount)
    @Html.HiddenFor(m => Model.objBooking.cRefundStatus)
    @Html.HiddenFor(m => Model.objBooking.cAmendStatus)
    @Html.HiddenFor(m => Model.objBooking.sPaymentMode)
    @Html.HiddenFor(m => Model.objBooking.sOAuth)
    @Html.HiddenFor(m => Model.objBooking.sExtra2)
    @Html.HiddenFor(m => Model.objBooking.sExtra3)
    @Html.HiddenFor(m => Model.objBooking.sExtra4)
    @Html.HiddenFor(m => Model.objBooking.sCurrencyCode)


    @Html.HiddenFor(m => Model.GuestData, new { id = "hdnJson" })

    for (int hdni = 0; hdni < Model.lsttblBookDetails.Count; hdni++)
    {
        @Html.HiddenFor(m => Model.lsttblBookDetails[hdni].iBookingDetailsID)
        @Html.HiddenFor(m => Model.lsttblBookDetails[hdni].iBookingId)
        @Html.HiddenFor(m => Model.lsttblBookDetails[hdni].iRoomId)
        @Html.HiddenFor(m => Model.lsttblBookDetails[hdni].iRPId)
        @Html.HiddenFor(m => Model.lsttblBookDetails[hdni].iRooms)
    }


    <div class="container margintop10" style="border:0px solid red;">
        <div class="row">

            <div class="col-md-8">
                <div class="row">
                    <div class="col-md-4 col-xs-12">

                        <img src='@Model.sRoomImageUrl' onerror="this.src='/images/noImage.jpg'" id="imagePreview" class="imgheight214">

                    </div>
                    <div class="col-md-6 col-xs-12">
                        <h3 class="mar-padd0"><strong>@Model.sPropertyName</strong></h3>
                        <div class="margintop-5"><img src="~/images/inner-star@(Model.iStarCategory).png" class="srchinner_star"></div>

                        <address>
                            @Model.sPropertyAddress
                            <div class="row margintop10">
                                <div class="col-md-12 col-xs-12 facilityicon">
                                    <ul>
                                        @for (int i = 0; i < Model.lstetblHotelFacilities.Count; i++)
                                        {
                                            <li><img src='@Model.lstetblHotelFacilities[i].sImgUrl' id="iconPreview" title="@Model.lstetblHotelFacilities[i].sHotelFacilites" style="height: 20px; width: 20px"></li>
                                        }
                                    </ul>
                                </div>
                            </div>
                            <hr>
                        </address>
                        <div class="row margintop-10">
                            <div class="col-md-12">
                                <div class="table-responsive noborder  info">
                                    <table class="table">
                                        <tr>
                                            <td>Check In:</td>
                                            <td><strong>@Model.scheckIn</strong></td>
                                        </tr>
                                        <tr>
                                            <td>Check Out:</td>
                                            <td><strong>@Model.scheckOut </strong></td>
                                        </tr>
                                        <tr>
                                            <td>Room(s):</td>
                                            <td><strong>@Model.iNoOfRooms</strong></td>
                                        </tr>
                                    </table>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 col-xs-12">
                <div class="row ">
                    <div class="col-md-12">
                        <h4 class="center">Total Summary </h4>
                        <hr>
                        <div class="row">
                            <div class="col-md-4 col-xs-5 pull-left">Rooms Rate</div>
                            <div class="col-md-1 col-xs-1">:</div>

                            <div class="col-md-7  col-xs-5 pull-right"><strong>@Model.Symbol @clsUtils.ConvertNumberToCommaSeprated(Convert.ToDecimal(Model.objBooking.dTotalAmount) * ViewBag.dExchangeRate)</strong></div>
                            @{GrandTotal = clsUtils.ConvertNumberToCommaSeprated(Convert.ToDecimal(Model.objBooking.dTotalAmount + Model.objBooking.dTotalExtraBedAmount + Model.objBooking.dTaxes) * ViewBag.dExchangeRate);}

                        </div>

                        <div class="row">
                            <div class="col-md-4  col-xs-5">Extra Bed Charges </div>
                            <div class="col-md-1 col-xs-1">:</div>
                            <div class="col-md-7  col-xs-5  pull-right"><strong>@Model.Symbol @clsUtils.ConvertNumberToCommaSeprated(Convert.ToDecimal(Model.objBooking.dTotalExtraBedAmount * ViewBag.dExchangeRate)) </strong></div>
                        </div>

                        <div class="row">
                            <div class="col-md-4  col-xs-5">Taxes and Service Fees </div>
                            <div class="col-md-1 col-xs-1">:</div>
                            <div class="col-md-7  col-xs-5  pull-right"><strong>@Model.Symbol @clsUtils.ConvertNumberToCommaSeprated(Convert.ToDecimal(Model.objBooking.dTaxes * ViewBag.dExchangeRate))</strong></div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-md-4  col-xs-5">Total</div>
                            <div class="col-md-1  col-xs-2">:</div>
                            <div class="col-md-7  col-xs-5  pull-right"><strong>@Model.Symbol @GrandTotal</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="container  margintop30">
        <div class=" greybg-lighter">

            <h4 id="checkur">
                Are you the guest?
                <span class="paddingleft10">
                    @Html.RadioButtonFor(model => model.objBooking.bSelfTravelling, true, new { @class = "radio-inline", @checked = "checked" })
                    <label for="Yes">Yes</label>
                    @Html.RadioButtonFor(model => model.objBooking.bSelfTravelling, false, new { @class = "radio-inline" })
                    <label for="No">No</label>
                </span>
            </h4>

        </div>
    </div>


    <div class="container">
        <div class=" margintop30">
            <div class="tablebluebg">Guest Information</div>
            <div class=" table-responsive  table-bordered  padding15 lightgrybg">
                <table class="table  table-bordered table-hover" id="tblmainrooms">
                    <thead>
                        <tr>
                            <th style="width:15%;">Room</th>
                            <th style="width:20%;"> Guest Name<span class="red">*</span></th>
                            <th style="width:20%;">Mail Id<span class="red">*</span>	</th>
                            <th style="width:29%;">Mobile<span class="red">*</span></th>
                            <th style="width:16%;">Add accompanying guest</th>
                        </tr>
                    </thead>
                    <tbody>

                        @for (int k = 0; k < Model.lsttblBookDetails.Count; k++)
                        {
                            var occupancy = Model.lsttblBookDetails[k].iOccupancy;

                            <tr class="newtr room@(CountIndex + 1)">

                                <td>
                                    <label>Room @(CountIndex + 1) <br /> @Model.lsttblBookDetails[k].sRoomName</label>
                                    @Html.HiddenFor(m => Model.lsttblBookDetails[k].iBookingDetailsID, new { @class = "hdnBookingDetailId" })
                                </td>
                                <td><input type="text" class="form-control gname mwidth130" value="@Model.objBooking.sFirstNameOFR @Model.objBooking.sLastNameOFR" maxlength="50" placeholder="Name"></td>
                                <td><input type="email" class="form-control gemail mwidth130" value="@Model.objBooking.sEmailOFR" maxlength="100" placeholder="Email"></td>
                                <td>
                                    @Html.DropDownListFor(model => model.sCountryPhoneCode, new SelectList(Model.CountryCodePhoneList, "sCode", "sFrontendCode", Model.objBooking.sCountryPhoneCode), new { data_live_search = "true", style = "width:50%; float:left", id = "countryCodeType" + (CountIndex + 1), maxlength = "20", @class = "form-control ddlCountryCodeUpdate" })

                                    <input type="text" style="width:50%; float:left" pattern=" ^[\-\+]?\d+$" class="form-control gphone mwidth130" value="@Model.objBooking.sMobileOFR" maxlength="10" placeholder="Phone No.">

                                </td>

                                <td id="tddefault@(CountIndex + 1)">
                                    <div class="margintop10"><a id="ancroom@(CountIndex + 1)" rid="@(Model.lsttblBookDetails[k].iBookingDetailsID)" roomcount="@(CountIndex + 1)" occupancy="@occupancy" rname="@Model.lsttblBookDetails[k].sRoomName" onclick="return AddGuest(this);" class="showpointer">Add accompanying guest</a></div>
                                    <div class="margintop10"><a class="clean showpointer">Cancel</a></div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="6" id="divRoom@(CountIndex + 1)"></td>
                            </tr>

                            CountIndex++;
                        }

                    </tbody>

                </table>

            </div>
            <div class="redtext">*Confirmation letter will be sent to all above contact details</div>
        </div>
    </div>

    <div class="container">
        <div class="col-md-12 center margintop20">
            <button type="submit" class="btn btn-primary  btn-lg">Show My Confirmation</button>
        </div>
    </div>
    <br />
}

<script>
    if (!document.referrer) {
        if (typeof history.pushState === 'function') {
            history.pushState('b', null, null);
            window.onpopstate = function () {
                history.pushState('b', null, null);
                return false;
            }
        }
    }
    else {
        if (typeof history.pushState === 'function') {
            history.pushState('b', null, null);
            var previousUrl = document.referrer.toString().toLowerCase();
            window.onpopstate = function () {
                history.pushState('b', null, null);
                return false;
            }
        }
        else {
            var ignoreHashChange = true;
            window.onhashchange = function () {
                if (!ignoreHashChange) {
                    ignoreHashChange = true;
                    window.location.hash = Math.random();
                    return false;
                }
                else {
                    ignoreHashChange = false;
                    return false;
                }
            };
        }
    }

    function isEmail(email) {
        var regex = /^([a-zA-Z0-9_.+-])+\@@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
        return regex.test(email);
    }

    function validatePhone(txtPhone) {
        var filter = /^[0-9-+]+$/;
        if (filter.test(txtPhone)) {
            if (txtPhone.length != 10) {
                return false;
            }
            return true;
        }
        else {
            return false;
        }
    }


    $(function () {

        $('.ddlCountryCodeUpdate').select2();
    });

</script>


<script type="text/javascript">

    var d = new Date();
    var dCheckIn = '';
    var dCheckOut = '';
    var newroomcount = '';
    var Data = [];


    $('#frmBookingAmend').submit(function (e) {

        $("#tblmainrooms tr.newtr").each(function () {

            var BookingDetailId = $(this).find("input:hidden.hdnBookingDetailId").val();
            var gname = $(this).find("input:text.gname").val();
            var gemail = $(this).find("input.gemail").val();
            var gphone = $(this).find("input:text.gphone").val();
            var ptype = $(this).find('select.ptypedefault option:selected').val();

            if (gname.trim() != ''
                && gemail.trim() != ''
                && gphone.trim() != ''
                && isEmail(gemail.trim())
                && validatePhone(gphone.trim())) {

                Data.push({
                    BookingDetailId: BookingDetailId,
                    gname: gname,
                    gemail: gemail,
                    gphone: gphone,
                    ptype: ptype
                });
            }
            else {

                Data = [];

                e.preventDefault();

                toastr.clear();

                var $this = $(this);

                if (gname.trim() == '') {
                    toastr.error('Please enter the guest name.');
                    $this.find("input:text.gname").focus();
                }

                else if (gemail.trim() == '') {

                    toastr.error('Please enter the email address.');
                    $this.find(".gemail").focus();
                }

                else if (!isEmail(gemail.trim())) {
                    toastr.error('Please enter a valid email address.');
                    $this.find(".gemail").focus();
                }


                //else if (gphone.trim() == '') {
                //    toastr.error('Please enter the mobile number.');
                //    $this.find("input:text.gphone").focus();
                //}

                else if (!validatePhone(gphone.trim())) {
                    toastr.error('Please enter a valid phone number.');
                    $this.find("input:text.gphone").focus();
                }

                return false;
            }
        });

        $("#hdnJson").val(JSON.stringify(Data));

        return true;

    });


    $('.clean').click(function (e) {
        e.preventDefault();
        $($(this).parent().parent().parent()[0].cells).each(function () {
            $(this).find("input.gname").val('');
            $(this).find("input.gemail").val('');
            $(this).find("input.gphone").val('');
            $(this).find('select.ptypedefault').prop('selectedIndex', 0);
        });
    });

    function AddGuest(obj) {

        var roomcount = $(obj).attr('roomcount');
        var rid = $(obj).attr('rid');
        var occupancy = $(obj).attr('occupancy');
        var rname = $(obj).attr('rname');
        var ptypevalue = $('#ptype' + roomcount + '').val();


        var selectCountryCodeType = $('#countryCodeType' + roomcount + ' :selected').val();
        var selectCountryCodeText = $('#countryCodeType' + roomcount + ' :selected').text();


        newroomcount = roomcount + 1;
        var totalguest = $('#tblmainrooms tr.room' + roomcount + '').length;
        var guestcount = totalguest + 1;
        if (totalguest >= occupancy) {
            toastr.warning('More name cannot be added.')
            return false;
        }
        var myval = '';
        myval += '<table  class="table  table-bordered table-hover" id="tblRoom' + roomcount + '"><tbody>';
        myval += '<tr class="newtr room' + roomcount + '">';
        myval += '<td style="width:10%;"><label>Room ' + roomcount + '<br/>' + rname + '</label><input type="hidden" value="' + rid + '" class="hdnBookingDetailId" /></td>';
        myval += '<td  style="width:13%;"><div class="form-group"><input type="text" class="form-control gname mwidth130" maxlength="50" placeholder="Name" ></div></td>';
        myval += '<td  style="width:14%;"><div class="form-group"><input type="email" class="form-control gemail mwidth130" maxlength="100" placeholder="Email" ></div></td>';
        myval += '<td  style="width:20%;"><div class="form-group">' +
           '<select disabled style="width:50%; float:left" class="form-control"><option value="' + selectCountryCodeType + '" selected>' + selectCountryCodeText + '</option></select>' +
                                 '<input type="text" style="width:50%; float:left" pattern="^[\-\+]?\d+$" class="form-control gphone mwidth130" maxlength="10" placeholder="Phone No." ></div></td>';
        myval += '<td  style="width:10%;">';
        myval += '<div class="margintop10"><a class="delete1 showpointer" href="#">Delete</a></div>';
        myval += '</td>';
        myval += '</tr>';
        myval += '</tbody></table>';

        $('#divRoom' + roomcount + '').append("" + myval + "");
        $('.delete1').click(function (e) {
            e.preventDefault();
            $(this).closest('table').remove();
        });

    }


    function AddGuestDetails(obj) {
        var roomcount = $(obj).attr('roomcount');
        var dcount = $(obj).attr('guestcount');
        var rid = $(obj).attr('rid');
        var occupancy = $(obj).attr('occupancy');
        var rname = $(obj).attr('rname');

        newroomcount = roomcount + 1;
        var guestcount = dcount + 1;
        var oldguestcount = $('#tblmainrooms tr.room' + roomcount + '').length;

        if (oldguestcount >= occupancy) {
            toastr.warning('More name cannot be added.')
            return false;
        }
        var myval = '';
        myval += '<tr class="newtr room' + roomcount + '">';
        myval += '<td><label>Room ' + roomcount + '<br/>' + rname + '</label><input type="hidden" value="' + rid + '" class="hdnBookingDetailId" /></td>';
        myval += '<td><div class="form-group"><input type="text" class="form-control gname" maxlength="50" placeholder="Name" ></div></td>';
        myval += '<td><div class="form-group"><input type="email" class="form-control gemail" maxlength="100" placeholder="Email" ></div></td>';
        myval += '<td><div class="form-group"><input type="text" pattern="^[\-\+]?\d+$" class="form-control gphone" maxlength="10" placeholder="Mobile No." ></div></td>';
        myval += '<td>';
        myval += '<div class="form-group">';
        myval += '<select class="form-control ptype"><option value="" >Select</option>';
        myval += '<option value="Single">Single</option>';
        myval += '<option value="Double">Double</option>';
        myval += '<option value="King Size">King Size</option></select>';
        myval += '</div>';

        myval += '</td>';
        myval += '<td>';
        myval += '</td>';
        myval += '<div class="margintop-10"><a id="ancroom' + roomcount + '' + guestcount + '"  rid="' + rid + '" roomcount="' + roomcount + '" guestcount="' + guestcount + '" occupancy="' + occupancy + '"  rname="' + rname + '" onclick="AddGuestDetails(this)">Add name of the accompanying guest</a></div>';
        myval += '</tr>';
        $('#ancroom' + roomcount + '' + dcount + '').html('Delete');
        $('#ancroom' + roomcount + '' + dcount + '').removeAttr('onclick');
        $('#ancroom' + roomcount + '' + dcount + '').addClass("delete1");

        $('#tblRoom' + roomcount + '').append(myval);

        $('.delete1').click(function (e) {
            e.preventDefault();
            $($(this).parent().parent().parent()[0].cells).each(function () {
                $(this).find("input.gname").val('');
                $(this).find("input.gemail").val('');
                $(this).find("input.gphone").val('');
                $(this).find('select.ptype').prop('selectedIndex', 0);
            });
        });
    }



    var pickup = '@Model.objBooking.spref_pickup';
    if (pickup == "Yes") {
        $('#tblpickup').show();
    }



    $('#divpickup input[type="radio"]').click(function () {
        if (this.value == "No" || this.value == "NA")
            $('#tblpickup').hide();
        else
            $('#tblpickup').show();
    });

    $('#checkur input[type="radio"]').click(function () {
        if (this.value == 'False') {
            $("#tblmainrooms tr.newtr").each(function () {
                $(this).find("input.gname").val('');
                $(this).find("input.gemail").val('');
                $(this).find("input.gphone").val('');
                $(this).find('select.ptype').prop('selectedIndex', 0);
            });
        }
    });

    $('.gphone').keypress(function (e) {

        var cursorPosition = $(this).getCursorPosition();

        if ((this.value.length == 0 || cursorPosition == 0) && e.which == 48) {

            return false;
        }
    });

</script>
